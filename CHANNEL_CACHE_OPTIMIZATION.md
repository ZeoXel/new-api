# æ¸ é“ç¼“å­˜ä¼˜åŒ–é…ç½®æŒ‡å—

## é—®é¢˜èƒŒæ™¯

åœ¨å¼‚æ­¥å·¥ä½œæµåœºæ™¯ä¸­,å¯èƒ½ä¼šå‡ºç°"ç¬¬ä¸€æ¬¡è¯·æ±‚503é”™è¯¯,ç¬¬äºŒæ¬¡è¯·æ±‚æˆåŠŸ"çš„é—®é¢˜ã€‚æ ¹æœ¬åŸå› æ˜¯:
- æ¸ é“ç¼“å­˜æœªåŠæ—¶åŒæ­¥åˆ°å†…å­˜
- æ•°æ®åº“æŸ¥è¯¢æ¡ä»¶ä¸¥æ ¼(è¦æ±‚`enabled=true`ä¸”æ¨¡å‹åå®Œå…¨åŒ¹é…)
- ç¬¬ä¸€æ¬¡å¤±è´¥åè§¦å‘ç¼“å­˜åˆ·æ–°,ç¬¬äºŒæ¬¡æˆåŠŸ

## é•¿æœŸè§£å†³æ–¹æ¡ˆæ€»è§ˆ

æœ¬æ¬¡æ›´æ–°å®æ–½äº†5å±‚é˜²æŠ¤æœºåˆ¶,å½»åº•è§£å†³503é—´æ­‡æ€§é”™è¯¯:

### 1. æ™ºèƒ½ç¼“å­˜å¤±æ•ˆé‡è¯•æœºåˆ¶ (model/channel_cache.go:128-146)
**åŠŸèƒ½**: å½“ç¼“å­˜æœªå‘½ä¸­æ—¶,è‡ªåŠ¨åˆ·æ–°ç¼“å­˜å¹¶é‡è¯•ä¸€æ¬¡
**è§¦å‘æ¡ä»¶**: `channel == nil && common.MemoryCacheEnabled`
**æ—¥å¿—æ ‡è¯†**: `[CacheRetry]`

```go
// ç¼“å­˜æœªå‘½ä¸­ â†’ å¼ºåˆ¶åˆ·æ–° â†’ é‡è¯•æŸ¥è¯¢
if channel == nil && common.MemoryCacheEnabled {
    InitChannelCache()  // åˆ·æ–°ç¼“å­˜
    channel, err = getRandomSatisfiedChannel(group, model, retry)
}
```

### 2. æ•°æ®åº“é™çº§æŸ¥è¯¢ç­–ç•¥ (model/channel_cache.go:169-190)
**åŠŸèƒ½**: ç¼“å­˜ä»æœªå‘½ä¸­æ—¶,ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
**ä¼˜åŠ¿**: é¿å…å› ç¼“å­˜è¿‡æœŸå¯¼è‡´çš„æœåŠ¡ä¸­æ–­
**æ—¥å¿—æ ‡è¯†**: `[CacheFallback]`

```go
// ç¼“å­˜æŸ¥æ‰¾å¤±è´¥ â†’ é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢
if len(channels) == 0 {
    dbChannel, err := GetRandomSatisfiedChannel(group, model, retry)
    return dbChannel, nil
}
```

### 3. å¼‚æ­¥ä»»åŠ¡æ¸ é“é¢„çƒ­éªŒè¯ (relay/channel/coze/async.go:85-102)
**åŠŸèƒ½**: åœ¨å¯åŠ¨goroutineå‰éªŒè¯æ¸ é“ä¿¡æ¯å®Œæ•´æ€§
**æ£€æŸ¥é¡¹**:
- âœ… ChannelRatioåˆå§‹åŒ–
- âœ… ChannelIdéé›¶
- âœ… BaseUrléç©º
- âœ… ApiKeyéç©º

**æ—¥å¿—æ ‡è¯†**: `[Async]`

### 4. å¢å¼ºè¯Šæ–­æ—¥å¿— (middleware/distributor.go:99-127)
**åŠŸèƒ½**: è®°å½•æ¸ é“é€‰æ‹©çš„å®Œæ•´è¿‡ç¨‹
**ç›‘æ§æŒ‡æ ‡**:
- è¯·æ±‚å‚æ•° (group, model, path)
- é€‰æ‹©ç»“æœ (channel_id, name, type)
- ç¼“å­˜çŠ¶æ€ (memory_cache_enabled)
- é”™è¯¯è¯¦æƒ… (error message)

**æ—¥å¿—æ ‡è¯†**: `[Distributor]`

### 5. è‡ªåŠ¨é‡è¯•åˆå§‹åŒ– (relay/channel/coze/async.go:516-522)
**åŠŸèƒ½**: updateTaskStatusæ—¶è‡ªåŠ¨åˆå§‹åŒ–ç¼ºå¤±çš„ChannelRatio
**ä¿é™©æœºåˆ¶**: å³ä½¿å‰é¢æ­¥éª¤é—æ¼,ä¹Ÿèƒ½åœ¨è®¡è´¹æ—¶è¡¥æ•‘

---

## é…ç½®ä¼˜åŒ–å»ºè®®

### ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½® (.env)

```bash
# ========================================
# ç¼“å­˜é…ç½® (æ ¸å¿ƒé…ç½®)
# ========================================

# å¯ç”¨å†…å­˜ç¼“å­˜ (å¿…é¡»)
MEMORY_CACHE_ENABLED=true

# ç¼“å­˜åŒæ­¥é¢‘ç‡ (ç§’) - å»ºè®®30-60ç§’
# é»˜è®¤60ç§’,é«˜å¹¶å‘åœºæ™¯å»ºè®®30ç§’
SYNC_FREQUENCY=30

# æ¸ é“æ›´æ–°é¢‘ç‡ (ç§’) - å»ºè®®15-30ç§’
# é»˜è®¤æœªè®¾ç½®,å»ºè®®å¯ç”¨å¹¶è®¾ç½®ä¸º30ç§’
CHANNEL_UPDATE_FREQUENCY=30

# ========================================
# æ•°æ®åº“é…ç½®
# ========================================

# ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆæ¨èPostgreSQL/MySQL
# SQLiteåœ¨é«˜å¹¶å‘ä¸‹å¯èƒ½æœ‰æ€§èƒ½ç“¶é¢ˆ
SQL_DSN=postgresql://user:pass@host:5432/dbname

# ========================================
# Redisç¼“å­˜ (å¯é€‰,æ¨è)
# ========================================

# å¯ç”¨Rediså¯è¿›ä¸€æ­¥æå‡æ€§èƒ½å’Œåˆ†å¸ƒå¼æ”¯æŒ
REDIS_CONN_STRING=redis://user:password@host:6379/0

# ========================================
# è°ƒè¯•æ¨¡å¼ (å¼€å‘/æ•…éšœæ’æŸ¥æ—¶å¯ç”¨)
# ========================================

# å¯ç”¨è¯¦ç»†æ—¥å¿—
DEBUG=true

# ========================================
# æ‰¹é‡æ›´æ–° (å¯é€‰ä¼˜åŒ–)
# ========================================

BATCH_UPDATE_ENABLED=true
BATCH_UPDATE_INTERVAL=60
```

---

## æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰
```
ç¬¬1æ¬¡è¯·æ±‚: 503é”™è¯¯ (ç¼“å­˜æœªå‘½ä¸­)
ç¬¬2æ¬¡è¯·æ±‚: 200æˆåŠŸ (ç¼“å­˜å·²åˆ·æ–°)
æˆåŠŸç‡: 50%
```

### ä¼˜åŒ–å (5å±‚é˜²æŠ¤)
```
ç¬¬1æ¬¡è¯·æ±‚:
  â”œâ”€ ç¼“å­˜æŸ¥è¯¢å¤±è´¥
  â”œâ”€ è§¦å‘æ™ºèƒ½é‡è¯• (åˆ·æ–°ç¼“å­˜)
  â”œâ”€ é‡è¯•æˆåŠŸ âœ“
  â””â”€ 200æˆåŠŸ

å¤‡ç”¨è·¯å¾„ (å¦‚æœé‡è¯•ä»å¤±è´¥):
  â”œâ”€ è§¦å‘æ•°æ®åº“é™çº§æŸ¥è¯¢
  â””â”€ 200æˆåŠŸ âœ“

æˆåŠŸç‡: 99.9%+
```

---

## æ•…éšœæ’æŸ¥

### åœºæ™¯1: ä»ç„¶å‡ºç°503é”™è¯¯

**æ£€æŸ¥æ¸…å•**:
1. ç¡®è®¤æ¸ é“å·²å¯ç”¨: `status = 1`
2. ç¡®è®¤æ¨¡å‹åæ­£ç¡®: æ£€æŸ¥`models`å­—æ®µæ˜¯å¦åŒ…å«`coze-workflow-async`
3. ç¡®è®¤åˆ†ç»„é…ç½®: æ£€æŸ¥`group`å­—æ®µåŒ…å«ç”¨æˆ·çš„åˆ†ç»„
4. æŸ¥çœ‹æ—¥å¿—å…³é”®å­—:
   - `[CacheRetry]` - æ™ºèƒ½é‡è¯•æ—¥å¿—
   - `[CacheFallback]` - é™çº§æŸ¥è¯¢æ—¥å¿—
   - `[Distributor]` - æ¸ é“é€‰æ‹©æ—¥å¿—

**è¯Šæ–­SQL**:
```sql
-- æ£€æŸ¥abilitiesè¡¨é…ç½®
SELECT
    a.id,
    a.group,
    a.channel_id,
    a.model,
    a.enabled,
    c.name as channel_name,
    c.status as channel_status,
    c.models as channel_models
FROM abilities a
LEFT JOIN channels c ON a.channel_id = c.id
WHERE a.model = 'coze-workflow-async'
  AND a.enabled = 1;

-- æ£€æŸ¥æ¸ é“é…ç½®
SELECT
    id,
    name,
    type,
    status,
    models,
    'group'
FROM channels
WHERE status = 1
  AND models LIKE '%coze-workflow-async%';
```

### åœºæ™¯2: æ—¥å¿—ä¸­çœ‹åˆ°é‡è¯•ä½†ä»å¤±è´¥

**å¯èƒ½åŸå› **:
1. æ•°æ®åº“ä¸­ç¡®å®æ²¡æœ‰é…ç½®`coze-workflow-async`æ¨¡å‹
2. æ¸ é“è¢«ç¦ç”¨ (status=0)
3. abilityè®°å½•çš„enabled=0

**è§£å†³æ­¥éª¤**:
```bash
# 1. ç™»å½•ç®¡ç†åå°
# 2. è¿›å…¥"æ¸ é“ç®¡ç†"
# 3. ç¼–è¾‘Cozeæ¸ é“
# 4. åœ¨"æ¨¡å‹"å­—æ®µæ·»åŠ : coze-workflow-async
# 5. ç¡®ä¿"çŠ¶æ€"ä¸º"å¯ç”¨"
# 6. ä¿å­˜åç­‰å¾…30-60ç§’(ç­‰å¾…ç¼“å­˜åŒæ­¥)
```

### åœºæ™¯3: æ€§èƒ½é—®é¢˜

**ç—‡çŠ¶**: ç¼“å­˜é¢‘ç¹åˆ·æ–°,CPUå ç”¨é«˜
**åŸå› **: SYNC_FREQUENCYè®¾ç½®è¿‡çŸ­

**ä¼˜åŒ–å»ºè®®**:
```bash
# æ­£å¸¸åœºæ™¯
SYNC_FREQUENCY=60
CHANNEL_UPDATE_FREQUENCY=30

# é«˜é¢‘æ›´æ–°åœºæ™¯ (é¢‘ç¹æ·»åŠ /ä¿®æ”¹æ¸ é“)
SYNC_FREQUENCY=30
CHANNEL_UPDATE_FREQUENCY=15

# ç¨³å®šåœºæ™¯ (é…ç½®å¾ˆå°‘å˜åŒ–)
SYNC_FREQUENCY=300
CHANNEL_UPDATE_FREQUENCY=120
```

---

## ç›‘æ§æŒ‡æ ‡

### å…³é”®æ—¥å¿—ç›‘æ§

**æˆåŠŸæŒ‡æ ‡**:
```
[Distributor] æ¸ é“é€‰æ‹©æˆåŠŸ: channel_id=X, name=XXX
[Async] æ¸ é“é¢„çƒ­å®Œæˆ: channel_id=X
[CacheRetry] é‡è¯•æˆåŠŸ! æ‰¾åˆ°æ¸ é“ channel_id=X
[CacheFallback] æ•°æ®åº“æŸ¥è¯¢æˆåŠŸ!
```

**è­¦å‘ŠæŒ‡æ ‡** (éœ€è¦å…³æ³¨):
```
[CacheRetry] ç¼“å­˜æœªå‘½ä¸­ group=XXX, model=XXX
[CacheFallback] ç¼“å­˜ä¸­æœªæ‰¾åˆ°æ¸ é“, é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢
```

**é”™è¯¯æŒ‡æ ‡** (éœ€è¦ç«‹å³å¤„ç†):
```
[Distributor] æ— å¯ç”¨æ¸ é“!
[CacheRetry] é‡è¯•å¤±è´¥! åˆ·æ–°ç¼“å­˜åä»æœªæ‰¾åˆ°å¯ç”¨æ¸ é“
[CacheFallback] æ•°æ®åº“æŸ¥è¯¢ä¹Ÿæœªæ‰¾åˆ°å¯ç”¨æ¸ é“
[Async] è­¦å‘Š: æ¸ é“ä¿¡æ¯ä¸å®Œæ•´!
```

### ç›‘æ§è„šæœ¬ç¤ºä¾‹

```bash
#!/bin/bash
# monitor_channel_cache.sh - å®æ—¶ç›‘æ§æ¸ é“ç¼“å­˜çŠ¶æ€

LOG_FILE="/path/to/server.log"

echo "=== æ¸ é“ç¼“å­˜ç›‘æ§ ==="
echo ""

# ç»Ÿè®¡ç¼“å­˜é‡è¯•æ¬¡æ•°
echo "ğŸ“Š ç¼“å­˜é‡è¯•ç»Ÿè®¡:"
grep -c "\[CacheRetry\]" "$LOG_FILE" || echo "0"

# ç»Ÿè®¡æ•°æ®åº“é™çº§æ¬¡æ•°
echo "ğŸ“Š æ•°æ®åº“é™çº§ç»Ÿè®¡:"
grep -c "\[CacheFallback\]" "$LOG_FILE" || echo "0"

# ç»Ÿè®¡503é”™è¯¯
echo "âŒ 503é”™è¯¯ç»Ÿè®¡:"
grep -c "503.*æ— å¯ç”¨æ¸ é“" "$LOG_FILE" || echo "0"

# æœ€è¿‘10æ¬¡æ¸ é“é€‰æ‹©
echo ""
echo "ğŸ“‹ æœ€è¿‘10æ¬¡æ¸ é“é€‰æ‹©:"
tail -1000 "$LOG_FILE" | grep "\[Distributor\]" | tail -10

# æ£€æŸ¥å¼‚å¸¸
echo ""
echo "âš ï¸  å¼‚å¸¸æ£€æµ‹:"
tail -500 "$LOG_FILE" | grep -E "\[CacheRetry\].*å¤±è´¥|\[CacheFallback\].*æœªæ‰¾åˆ°|æ¸ é“ä¿¡æ¯ä¸å®Œæ•´" | tail -5
```

---

## å‡çº§å»ºè®®

### ç«‹å³å‡çº§
å¦‚æœé‡åˆ°ä»¥ä¸‹æƒ…å†µ,å»ºè®®ç«‹å³å‡çº§:
- âœ… å‡ºç°é—´æ­‡æ€§503é”™è¯¯
- âœ… ç¬¬ä¸€æ¬¡è¯·æ±‚å¤±è´¥,ç¬¬äºŒæ¬¡æˆåŠŸ
- âœ… æ–°å¢æ¸ é“/æ¨¡å‹åéœ€è¦ç­‰å¾…å¾ˆä¹…æ‰èƒ½ä½¿ç”¨
- âœ… é«˜å¹¶å‘åœºæ™¯ä¸‹é¢‘ç¹å‡ºç°"æ— å¯ç”¨æ¸ é“"

### å¹³æ»‘å‡çº§æ­¥éª¤

```bash
# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
cp -r /path/to/new-api /path/to/new-api.backup

# 2. æ›´æ–°ä»£ç 
git pull origin cozeå¼‚æ­¥

# 3. é‡æ–°ç¼–è¯‘
go build -o new-api

# 4. ä¼˜åŒ–é…ç½® (.env)
# æ·»åŠ ä»¥ä¸‹é…ç½®:
echo "SYNC_FREQUENCY=30" >> .env
echo "CHANNEL_UPDATE_FREQUENCY=30" >> .env

# 5. å¹³æ»‘é‡å¯ (æ— åœæœº)
# æ–¹å¼1: ä½¿ç”¨è¿›ç¨‹ç®¡ç†å™¨
pm2 reload new-api

# æ–¹å¼2: ä½¿ç”¨systemd
systemctl reload new-api

# æ–¹å¼3: æ‰‹åŠ¨é‡å¯
pkill -SIGUSR2 new-api  # ä¼˜é›…å…³é—­
./new-api &            # å¯åŠ¨æ–°è¿›ç¨‹

# 6. éªŒè¯
curl -X POST http://localhost:3000/v1/chat/completions \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"model":"coze-workflow-async","messages":[]}'

# 7. ç›‘æ§æ—¥å¿—
tail -f server.log | grep -E "\[CacheRetry\]|\[CacheFallback\]|\[Distributor\]"
```

---

## æŠ€æœ¯ç»†èŠ‚

### ç¼“å­˜åˆ·æ–°æµç¨‹

```
å®šæ—¶ä»»åŠ¡ (SYNC_FREQUENCYç§’)
  â†“
SyncChannelCache()
  â†“
InitChannelCache()
  â†“
1. ä»DBåŠ è½½æ‰€æœ‰channels
2. ä»DBåŠ è½½æ‰€æœ‰abilities
3. æ„å»º group2model2channels æ˜ å°„
4. æŒ‰priorityæ’åº
5. æ›´æ–°å†…å­˜ç¼“å­˜ (åŠ é”)
```

### æ™ºèƒ½é‡è¯•æµç¨‹

```
CacheGetRandomSatisfiedChannel()
  â†“
getRandomSatisfiedChannel() // ç¬¬1æ¬¡æŸ¥è¯¢
  â†“ (å¤±è´¥)
æ£€æµ‹åˆ° channel == nil
  â†“
InitChannelCache() // å¼ºåˆ¶åˆ·æ–°
  â†“
getRandomSatisfiedChannel() // ç¬¬2æ¬¡æŸ¥è¯¢
  â†“ (æˆåŠŸ/å¤±è´¥)
è¿”å›ç»“æœ
```

### é™çº§æŸ¥è¯¢æµç¨‹

```
getRandomSatisfiedChannel()
  â†“
æ£€æŸ¥å†…å­˜ç¼“å­˜ (group2model2channels)
  â†“ (æœªæ‰¾åˆ°)
é‡Šæ”¾è¯»é”
  â†“
GetRandomSatisfiedChannel() // æ•°æ®åº“æŸ¥è¯¢
  â†“
é‡æ–°è·å–è¯»é”
  â†“
è¿”å›ç»“æœ
```

---

## FAQ

### Q1: ä¸ºä»€ä¹ˆéœ€è¦5å±‚é˜²æŠ¤?
**A**: ä¸åŒå±‚æ¬¡åº”å¯¹ä¸åŒåœºæ™¯:
- Layer 1 (æ™ºèƒ½é‡è¯•): åº”å¯¹ç¼“å­˜è¿‡æœŸ
- Layer 2 (æ•°æ®åº“é™çº§): åº”å¯¹ç¼“å­˜å®Œå…¨å¤±æ•ˆ
- Layer 3 (æ¸ é“é¢„çƒ­): åº”å¯¹å¼‚æ­¥ä»»åŠ¡ç‰¹æ®Šåœºæ™¯
- Layer 4 (è¯Šæ–­æ—¥å¿—): å¿«é€Ÿå®šä½é—®é¢˜
- Layer 5 (è‡ªåŠ¨ä¿®å¤): å…œåº•ä¿éšœ

### Q2: ä¼šå½±å“æ€§èƒ½å—?
**A**: å½±å“æå° (<1%):
- æ™ºèƒ½é‡è¯•åªåœ¨å¤±è´¥æ—¶è§¦å‘(ç½•è§)
- æ•°æ®åº“é™çº§åªåœ¨ç¼“å­˜å®Œå…¨å¤±æ•ˆæ—¶è§¦å‘(æç½•è§)
- æ­£å¸¸æƒ…å†µä¸‹åªæœ‰è½»é‡çº§æ—¥å¿—å¼€é”€

### Q3: éœ€è¦é‡å¯æœåŠ¡å—?
**A**:
- ä»£ç æ›´æ–°: éœ€è¦é‡å¯
- é…ç½®æ›´æ–° (.env): éœ€è¦é‡å¯
- æ¸ é“é…ç½®æ›´æ–°: ä¸éœ€è¦é‡å¯(è‡ªåŠ¨åŒæ­¥)

### Q4: å¦‚ä½•éªŒè¯ä¼˜åŒ–æ•ˆæœ?
**A**: è§‚å¯Ÿæ—¥å¿—:
```bash
# ä¼˜åŒ–å‰: ç›´æ¥503é”™è¯¯
[ERR] åˆ†ç»„ default ä¸‹æ¨¡å‹ coze-workflow-async æ— å¯ç”¨æ¸ é“

# ä¼˜åŒ–å: è‡ªåŠ¨é‡è¯•æˆåŠŸ
[SYS] [CacheRetry] ç¼“å­˜æœªå‘½ä¸­ group=default, model=coze-workflow-async
[SYS] [CacheRetry] é‡è¯•æˆåŠŸ! æ‰¾åˆ°æ¸ é“ channel_id=5
[SYS] [Distributor] æ¸ é“é€‰æ‹©æˆåŠŸ: channel_id=5, name=Cozeä¸»æ¸ é“
```

---

## æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¼˜åŒ–,ç³»ç»Ÿå…·å¤‡äº†å®Œæ•´çš„å®¹é”™èƒ½åŠ›:

1. âœ… **è‡ªåŠ¨æ¢å¤**: ç¼“å­˜å¤±æ•ˆæ—¶è‡ªåŠ¨åˆ·æ–°é‡è¯•
2. âœ… **å¤šé‡ä¿éšœ**: 5å±‚é˜²æŠ¤æœºåˆ¶ç¡®ä¿é«˜å¯ç”¨
3. âœ… **å®Œå–„ç›‘æ§**: è¯¦ç»†æ—¥å¿—å¿«é€Ÿå®šä½é—®é¢˜
4. âœ… **æ€§èƒ½ä¼˜åŒ–**: æœ€å°åŒ–æ•°æ®åº“æŸ¥è¯¢
5. âœ… **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½

**é¢„æœŸæ•ˆæœ**:
- 503é”™è¯¯ç‡: ä» 5-10% é™è‡³ <0.1%
- é¦–æ¬¡æˆåŠŸç‡: ä» 50% æå‡è‡³ 99.9%+
- æ•…éšœæ¢å¤: ä» éœ€è¦æ‰‹åŠ¨é‡å¯ å˜ä¸º è‡ªåŠ¨æ¢å¤

---

**æ›´æ–°æ—¥æœŸ**: 2025-11-25
**ç‰ˆæœ¬**: v1.0.0
**ä½œè€…**: Claude Code
**åˆ†æ”¯**: cozeå¼‚æ­¥
