# Bltcy é€ä¼ æ¨¡å¼ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## âœ… ä»£ç æ£€æŸ¥æ¸…å•

å·²éªŒè¯ä»£ç ä¸­**æ— æœ¬åœ°ç¯å¢ƒä¾èµ–**ï¼š
- âœ… æ— ç¡¬ç¼–ç çš„ localhost æˆ–æœ¬åœ° IP
- âœ… æ— ç¡¬ç¼–ç çš„å¼€å‘ç¯å¢ƒç‰¹å®šURL
- âœ… æ‰€æœ‰è¶…æ—¶é…ç½®å‡ä¸ºå¸¸é‡ï¼Œé€‚ç”¨äºå„ç§ç½‘ç»œç¯å¢ƒ
- âœ… æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶è®¾ç½®

---

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### 1. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

```bash
# å…‹éš†æˆ–æ‹‰å–æœ€æ–°ä»£ç 
cd /path/to/new-api
git pull origin main

# ç¼–è¯‘ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ä¼˜åŒ–ç¼–è¯‘ï¼‰
go build -ldflags "-s -w" -o one-api

# æˆ–ä½¿ç”¨ Docker éƒ¨ç½²
docker build -t new-api:latest .
```

### 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

è™½ç„¶å½“å‰ç‰ˆæœ¬ä¸éœ€è¦ç‰¹æ®Šç¯å¢ƒå˜é‡ï¼Œä½†å»ºè®®è®¾ç½®ï¼š

```bash
# .env æ–‡ä»¶ç¤ºä¾‹
PORT=3000
SQL_DSN=mysql://user:pass@host:3306/dbname
REDIS_CONN_STRING=redis://localhost:6379
SESSION_SECRET=your-secret-key
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# ç›´æ¥å¯åŠ¨
./one-api

# æˆ–ä½¿ç”¨ systemdï¼ˆæ¨èï¼‰
sudo systemctl start new-api
sudo systemctl enable new-api

# æˆ–ä½¿ç”¨ Docker
docker run -d \
  -p 3000:3000 \
  -v /path/to/config:/app/config \
  --name new-api \
  new-api:latest
```

---

## ğŸ”§ ç”Ÿäº§ç¯å¢ƒé…ç½®æŒ‡å—

### A. ç®¡ç†åå°é…ç½® Bltcy æ¸ é“

#### æ­¥éª¤ 1ï¼šåˆ›å»ºæ¸ é“

1. ç™»å½•ç®¡ç†åå°
2. è¿›å…¥ **æ¸ é“** é¡µé¢
3. ç‚¹å‡» **æ·»åŠ æ¸ é“**
4. é€‰æ‹©æ¸ é“ç±»å‹ï¼š**æ—§ç½‘å…³ï¼ˆBltcyï¼‰[55]**

#### æ­¥éª¤ 2ï¼šé…ç½®æ¸ é“å‚æ•°

| å‚æ•° | é…ç½®ç¤ºä¾‹ | è¯´æ˜ |
|------|----------|------|
| **æ¸ é“åç§°** | `æ—§ç½‘å…³-ç»Ÿä¸€` | è‡ªå®šä¹‰åç§° |
| **æ¸ é“ç±»å‹** | `55 - æ—§ç½‘å…³ï¼ˆBltcyï¼‰` | å¿…é¡»é€‰æ‹©æ­¤ç±»å‹ |
| **Base URL** | `https://api.bltcy.ai` | âš ï¸ **é‡è¦**ï¼šä¸è¦åŒ…å«è·¯å¾„ï¼Œä¸è¦ä»¥ `/` ç»“å°¾ |
| **å¯†é’¥ (Key)** | `sk-xxx...` | æ—§ç½‘å…³çš„ API å¯†é’¥ |
| **çŠ¶æ€** | `å¯ç”¨` | |
| **ä¼˜å…ˆçº§** | `0` | é»˜è®¤å³å¯ |

**Base URL é…ç½®ç¤ºä¾‹**ï¼š
```
âœ… æ­£ç¡®ï¼šhttps://api.bltcy.ai
âœ… æ­£ç¡®ï¼šhttp://your-old-gateway.com
âŒ é”™è¯¯ï¼šhttps://api.bltcy.ai/
âŒ é”™è¯¯ï¼šhttps://api.bltcy.ai/kling
âŒ é”™è¯¯ï¼šhttps://api.bltcy.ai/runway/v1
```

#### æ­¥éª¤ 3ï¼šé…ç½®æ”¯æŒçš„æ¨¡å‹

åœ¨**æ¨¡å‹æ˜ å°„**ä¸­æ·»åŠ éœ€è¦æ”¯æŒçš„æœåŠ¡ï¼ˆä½¿ç”¨åŸºç¡€åç§°ï¼Œä¸å¸¦ç‰ˆæœ¬å·ï¼‰ï¼š

```
runway      â† æ”¯æŒ /runway/* å’Œ /runwayml/* è·¯å¾„
pika        â† æ”¯æŒ /pika/* è·¯å¾„
kling       â† æ”¯æŒ /kling/* è·¯å¾„
jimeng      â† æ”¯æŒ /jimeng/* è·¯å¾„
suno        â† æ”¯æŒ /suno/* è·¯å¾„ï¼ˆå¦‚æœæ—§ç½‘å…³æ”¯æŒï¼‰
```

**é…ç½®æ ¼å¼**ï¼š
- ä¸€è¡Œä¸€ä¸ªæ¨¡å‹å
- ä½¿ç”¨åŸºç¡€åç§°ï¼ˆå°å†™ï¼‰
- ä¸è¦æ·»åŠ ç‰ˆæœ¬å·æˆ–åç¼€

#### æ­¥éª¤ 4ï¼šé…ç½®é€ä¼ é…é¢ï¼ˆå¯é€‰ï¼‰

åœ¨æ¸ é“çš„ **è®¾ç½®ï¼ˆSettingsï¼‰** JSON ä¸­é…ç½®ï¼š

```json
{
  "PassthroughQuota": 1000
}
```

**è¯´æ˜**ï¼š
- `PassthroughQuota`: æ¯æ¬¡è¯·æ±‚æ‰£é™¤çš„é…é¢ï¼ˆé»˜è®¤ 1000ï¼‰
- å¯æ ¹æ®å®é™…æˆæœ¬è°ƒæ•´

---

### B. ç”¨æˆ·ä»¤ç‰Œé…ç½®

ç”¨æˆ·ä½¿ç”¨ Bltcy é€ä¼ æ¨¡å¼ä¸éœ€è¦ç‰¹æ®Šé…ç½®ï¼Œåªéœ€ï¼š

1. **åˆ›å»ºä»¤ç‰Œ**ï¼ˆæˆ–ä½¿ç”¨ç°æœ‰ä»¤ç‰Œï¼‰
2. **ç¡®ä¿ä»¤ç‰Œæœ‰è¶³å¤Ÿé…é¢**
3. **ç¡®è®¤ä»¤ç‰Œå¯ä»¥è®¿é—®ç›¸åº”æ¨¡å‹**ï¼ˆå¦‚æœå¯ç”¨äº†æ¨¡å‹é™åˆ¶ï¼‰

---

## ğŸŒ å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹

### Runway æœåŠ¡

```bash
# ä½¿ç”¨ /runway/ è·¯å¾„
curl -X POST https://your-domain.com/runway/v1/image_to_video \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"prompt": "test video"}'

# ä½¿ç”¨ /runwayml/ è·¯å¾„ï¼ˆå…¼å®¹ï¼‰
curl -X POST https://your-domain.com/runwayml/v1/image_to_video \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"prompt": "test video"}'
```

### Pika æœåŠ¡

```bash
curl -X POST https://your-domain.com/pika/generate \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"prompt": "test video"}'
```

### Kling æœåŠ¡

```bash
# æäº¤ä»»åŠ¡
curl -X POST https://your-domain.com/kling/v1/videos/image2video \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"model":"kling-v1-6","prompt":"test","image":"base64..."}'

# æŸ¥è¯¢ä»»åŠ¡ï¼ˆGET è¯·æ±‚ï¼‰
curl -X GET https://your-domain.com/kling/v1/videos/image2video/TASK_ID \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼š500 é”™è¯¯ - TLS handshake timeout

**ç—‡çŠ¶**ï¼š
```json
{
  "code": "request_failed",
  "message": "è½¬å‘è¯·æ±‚åˆ°æ—§ç½‘å…³å¤±è´¥: TLS handshake timeout"
}
```

**åŸå› **ï¼š
1. æ— æ³•è®¿é—®æ—§ç½‘å…³åœ°å€
2. ç½‘ç»œå»¶è¿Ÿè¿‡é«˜
3. é˜²ç«å¢™é˜»æ­¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æµ‹è¯•è¿æ¥
curl -v https://api.bltcy.ai

# 2. æ£€æŸ¥é˜²ç«å¢™
sudo iptables -L

# 3. å¦‚æœä½¿ç”¨ä»£ç†ï¼Œé…ç½®ä»£ç†ç¯å¢ƒå˜é‡
export http_proxy=http://proxy:port
export https_proxy=http://proxy:port
```

### é—®é¢˜ 2ï¼š400 é”™è¯¯ - Invalid request

**ç—‡çŠ¶**ï¼šè¿”å› 400 Bad Request

**å¸¸è§åŸå› **ï¼š
1. Base URL é…ç½®é”™è¯¯ï¼ˆåŒ…å«äº†è·¯å¾„æˆ–å°¾éƒ¨æ–œæ ï¼‰
2. æ¨¡å‹åç§°æœªé…ç½®
3. æ—§ç½‘å…³å¯†é’¥æ— æ•ˆ

**æ£€æŸ¥æ¸…å•**ï¼š
```bash
# 1. æ£€æŸ¥ Base URL é…ç½®
æ­£ç¡®ï¼šhttps://api.bltcy.ai
é”™è¯¯ï¼šhttps://api.bltcy.ai/

# 2. éªŒè¯æ¨¡å‹é…ç½®
åœ¨æ¸ é“çš„æ¨¡å‹æ˜ å°„ä¸­ç¡®è®¤å·²æ·»åŠ å¯¹åº”çš„æ¨¡å‹åï¼ˆå¦‚ "kling"ï¼‰

# 3. æµ‹è¯•æ—§ç½‘å…³è¿æ¥
curl -H "Authorization: Bearer YOUR_OLD_GATEWAY_KEY" \
     https://api.bltcy.ai/kling/v1/videos/image2video
```

### é—®é¢˜ 3ï¼š404 é”™è¯¯ - è·¯å¾„ä¸åŒ¹é…

**ç—‡çŠ¶**ï¼šè¿”å› 404 Not Found

**åŸå› **ï¼šè¯·æ±‚è·¯å¾„æœªåŒ¹é…åˆ° Bltcy è·¯ç”±

**è§£å†³æ–¹æ¡ˆ**ï¼š
ç¡®è®¤è¯·æ±‚è·¯å¾„ä½¿ç”¨ä»¥ä¸‹å‰ç¼€ä¹‹ä¸€ï¼š
- `/runway/*` æˆ– `/runwayml/*`
- `/pika/*`
- `/kling/*`
- `/jimeng/*`

### é—®é¢˜ 4ï¼šæ¸ é“æ— æ³•é€‰æ‹©

**ç—‡çŠ¶**ï¼šè¯·æ±‚è¿”å› "æ— å¯ç”¨æ¸ é“"

**åŸå› **ï¼š
1. æ¸ é“æœªå¯ç”¨
2. æ¨¡å‹æ˜ å°„æœªé…ç½®
3. ä»¤ç‰Œæ²¡æœ‰æƒé™è®¿é—®è¯¥æ¨¡å‹

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤æ¸ é“çŠ¶æ€ä¸º "å¯ç”¨"
2. åœ¨æ¨¡å‹æ˜ å°„ä¸­æ·»åŠ å¯¹åº”çš„æ¨¡å‹å
3. æ£€æŸ¥ä»¤ç‰Œçš„æ¨¡å‹è®¿é—®æƒé™

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
# Docker éƒ¨ç½²
docker logs -f new-api

# systemd éƒ¨ç½²
journalctl -u new-api -f

# ç›´æ¥è¿è¡Œ
tail -f one-api.log
```

### å…³é”®æ—¥å¿—å…³é”®è¯

æœç´¢ä»¥ä¸‹å…³é”®è¯æ’æŸ¥é—®é¢˜ï¼š

```bash
# Bltcy é€ä¼ æ—¥å¿—
grep "DEBUG Bltcy" one-api.log

# Kling è¯·æ±‚æ—¥å¿—
grep "DEBUG Kling" one-api.log

# é”™è¯¯æ—¥å¿—
grep "ERR" one-api.log
```

### æ€§èƒ½ç›‘æ§

å»ºè®®ç›‘æ§çš„æŒ‡æ ‡ï¼š
- **è¯·æ±‚å»¶è¿Ÿ**ï¼šBltcy é€ä¼ å¢åŠ çš„å»¶è¿Ÿé€šå¸¸ < 100ms
- **é”™è¯¯ç‡**ï¼šTLS æ¡æ‰‹è¶…æ—¶åº”è¯¥ < 1%
- **å†…å­˜ä½¿ç”¨**ï¼šæ¯ä¸ªè¯·æ±‚å¢åŠ çº¦ 1-2KB

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä½¿ç”¨ HTTPS**
   - ç”Ÿäº§ç¯å¢ƒå¿…é¡»é…ç½® HTTPS
   - ä½¿ç”¨æœ‰æ•ˆçš„ SSL è¯ä¹¦ï¼ˆLet's Encrypt å…è´¹ï¼‰

2. **å¯†é’¥ç®¡ç†**
   - æ—§ç½‘å…³å¯†é’¥å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå·²åŠ å¯†
   - ä¸è¦åœ¨æ—¥å¿—ä¸­è¾“å‡ºå¯†é’¥
   - å®šæœŸè½®æ¢å¯†é’¥

3. **è®¿é—®æ§åˆ¶**
   - ä¸ºä¸åŒç”¨æˆ·ç»„é…ç½®ä¸åŒçš„ä»¤ç‰Œ
   - ä½¿ç”¨é…é¢é™åˆ¶é¿å…æ»¥ç”¨
   - å¯ç”¨ IP ç™½åå•ï¼ˆå¯é€‰ï¼‰

4. **é˜²ç«å¢™é…ç½®**
   ```bash
   # åªå…è®¸å¿…è¦çš„ç«¯å£
   sudo ufw allow 3000/tcp
   sudo ufw allow 443/tcp
   sudo ufw enable
   ```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥æ± ä¼˜åŒ–

ä»£ç ä¸­å·²é…ç½®ï¼š
- `MaxIdleConns: 100` - æœ€å¤§ç©ºé—²è¿æ¥
- `IdleConnTimeout: 90s` - ç©ºé—²è¿æ¥è¶…æ—¶
- `DisableKeepAlives: false` - å¯ç”¨è¿æ¥å¤ç”¨

### 2. è¶…æ—¶é…ç½®

å½“å‰é…ç½®ï¼š
- **æ€»è¶…æ—¶**: 300 ç§’ï¼ˆ5 åˆ†é’Ÿï¼‰
- **TLS æ¡æ‰‹è¶…æ—¶**: 60 ç§’
- **å“åº”å¤´è¶…æ—¶**: 60 ç§’

å¦‚éœ€è°ƒæ•´ï¼Œä¿®æ”¹ `relay/channel/bltcy/adaptor.go`:
```go
timeout := time.Second * 300  // è°ƒæ•´æ­¤å€¼
TLSHandshakeTimeout: 60 * time.Second  // è°ƒæ•´æ­¤å€¼
```

### 3. æ•°æ®åº“ä¼˜åŒ–

```bash
# ä¸ºæ¸ é“è¡¨æ·»åŠ ç´¢å¼•ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
CREATE INDEX idx_channels_type ON channels(type);
CREATE INDEX idx_channels_status ON channels(status);
```

---

## ğŸ¯ å®Œæ•´éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] ä»£ç å·²æ‹‰å–åˆ°æœ€æ–°ç‰ˆæœ¬
- [ ] ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] æœåŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨
- [ ] ç®¡ç†åå°å¯ä»¥è®¿é—®
- [ ] å·²åˆ›å»º Bltcy æ¸ é“ï¼ˆç±»å‹ 55ï¼‰
- [ ] Base URL é…ç½®æ­£ç¡®ï¼ˆæ— å°¾éƒ¨æ–œæ ï¼‰
- [ ] æ¨¡å‹æ˜ å°„å·²é…ç½®ï¼ˆrunwayã€pikaã€kling ç­‰ï¼‰
- [ ] ç”¨æˆ·ä»¤ç‰Œå·²åˆ›å»º
- [ ] å®¢æˆ·ç«¯å¯ä»¥æ­£å¸¸è°ƒç”¨
- [ ] æ—¥å¿—æ­£å¸¸è¾“å‡ºï¼Œæ— å¼‚å¸¸é”™è¯¯
- [ ] HTTPS è¯ä¹¦é…ç½®æ­£ç¡®
- [ ] é˜²ç«å¢™è§„åˆ™é…ç½®å®Œæˆ
- [ ] ç›‘æ§å’Œå‘Šè­¦å·²è®¾ç½®

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**ï¼šä½¿ç”¨ä¸Šé¢çš„æ—¥å¿—å‘½ä»¤
2. **æ£€æŸ¥é…ç½®**ï¼šä½¿ç”¨æ•…éšœæ’æŸ¥éƒ¨åˆ†çš„æ£€æŸ¥æ¸…å•
3. **æŸ¥é˜…æ–‡æ¡£**ï¼šå‚è€ƒ `BLTCY_FINAL_FIX_REPORT.md`
4. **æäº¤ Issue**ï¼šå¦‚æœæ˜¯ bugï¼Œè¯·åœ¨ GitHub æäº¤ issue

---

## ğŸ“ æ›´æ–°æ—¥å¿—

**2025-10-11**
- âœ… å®Œæˆ Bltcy é€ä¼ æ¨¡å¼æ ¸å¿ƒåŠŸèƒ½
- âœ… ä¿®å¤ TLS æ¡æ‰‹è¶…æ—¶é—®é¢˜
- âœ… ä¿®å¤ Kling GET è¯·æ±‚ 400 é”™è¯¯
- âœ… æ·»åŠ  Runway/Runwayml åŒè·¯å¾„æ”¯æŒ
- âœ… ä¼˜åŒ– HTTP Transport é…ç½®
- âœ… å®Œæˆç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ–‡æ¡£

---

**éƒ¨ç½²æˆåŠŸï¼ğŸ‰**

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒæ•…éšœæ’æŸ¥éƒ¨åˆ†æˆ–æŸ¥çœ‹æ—¥å¿—ã€‚
