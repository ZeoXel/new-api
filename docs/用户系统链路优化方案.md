# 用户系统链路架构优化方案

> 文档版本: v1.0
> 创建日期: 2025-01-XX
> 状态: 待实施

---

## 一、背景与问题

### 1.1 当前架构概述

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   门户平台      │────▶│  Supabase        │     │  new-api网关    │
│ (前端+认证)     │     │  (数据库)         │     │  (Railway)      │
└─────────────────┘     └──────────────────┘     └─────────────────┘
       │                       │                        │
       │ 用户注册              │ 密钥池                 │ Token生成
       │ 充值系统              │ 分配记录               │ 48字符格式
```

### 1.2 核心痛点

| 痛点 | 描述 | 影响 |
|------|------|------|
| **密钥双端存储** | new-api生成密钥 vs supabase分配密钥，需手动同步 | 运维成本高、易出错 |
| **格式不一致** | new-api用48字符格式，supabase可能用不同格式 | 集成困难 |
| **计费依赖API** | 余额=充值-消耗，需实时查询new-api | 延迟高、依赖性强 |
| **iframe信息孤岛** | 用户信息只能通过URL传递 | 安全性弱 |
| **消费明细缺失** | 门户无法展示用户消费详情图表 | 用户体验差 |

---

## 二、优化方案总览

### 2.1 目标架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          用户系统链路 - 目标架构                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

                                 ┌─────────────────┐
                                 │    用户浏览器    │
                                 └────────┬────────┘
                                          │
              ┌───────────────────────────┼───────────────────────────┐
              ▼                           ▼                           ▼
     ┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
     │    门户平台     │         │  iframe模块A   │         │  iframe模块B   │
     └────────┬────────┘         └────────┬────────┘         └────────┬────────┘
              │                           │                           │
              └───────────────────────────┼───────────────────────────┘
                                          │
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║                         Supabase (统一数据中心)                           ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║  ┌──────────────┐   ┌──────────────┐   ┌──────────────────────────────┐  ║
    ║  │    users     │   │   api_keys   │   │      user_balance           │  ║
    ║  │  (用户表)    │──▶│  (密钥池)    │   │      (余额表)               │  ║
    ║  └──────────────┘   └──────┬───────┘   └──────────────────────────────┘  ║
    ╚══════════════════════════════╦════════════════════════════════════════════╝
                                   ║ Webhook同步
    ╔══════════════════════════════╩════════════════════════════════════════════╗
    ║                        new-api 网关 (Railway)                             ║
    ╠═══════════════════════════════════════════════════════════════════════════╣
    ║  ┌─────────────────────────────────────────────────────────────────────┐ ║
    ║  │  • POST /api/token/import         外部密钥导入                      │ ║
    ║  │  • GET  /api/usage/token/detail   消费详情                          │ ║
    ║  │  • GET  /api/usage/token/chart    图表数据                          │ ║
    ║  └─────────────────────────────────────────────────────────────────────┘ ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
```

### 2.2 优化模块清单

| 模块 | 优化方案 | 优先级 | 状态 |
|------|----------|--------|------|
| 密钥同步 | Supabase密钥池 + Webhook同步到new-api | P0 | 待实施 |
| 消费明细 | 方案A - 基于密钥的消费数据API | P0 | 待实施 |
| 计费系统 | 消费Webhook回调更新余额 | P1 | 规划中 |
| iframe通信 | 短期JWT令牌 + postMessage | P2 | 规划中 |

---

## 三、密钥同步机制

### 3.1 方案设计

**核心思路**：Supabase 成为密钥的**唯一真实来源（Single Source of Truth）**

```
用户注册 → Supabase生成统一格式密钥 → Webhook调用new-api导入Token
    │                │                           │
    ▼                ▼                           ▼
 创建用户       生成密钥                    POST /api/token/import
                (sk-前缀+48字符)                  │
                    │                            │
                    └──────────同步──────────────┘
```

### 3.2 统一密钥格式

```
标准格式: sk-{48字符随机串}
字符集:   0-9a-zA-Z (与new-api一致)
示例:     sk-a1B2c3D4e5F6g7H8i9J0k1L2m3N4o5P6q7R8s9T0u1V2w3X4
长度:     51字符 (含sk-前缀)
```

### 3.3 Supabase 表结构

```sql
-- 密钥池表
CREATE TABLE api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    key TEXT NOT NULL UNIQUE,           -- 密钥 (sk-xxx格式)
    name TEXT DEFAULT 'default',        -- 密钥名称
    status INTEGER DEFAULT 1,           -- 1=启用, 2=禁用
    newapi_synced BOOLEAN DEFAULT FALSE,-- 是否已同步到new-api
    newapi_token_id INTEGER,            -- new-api中的token_id
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_api_keys_user_id ON api_keys(user_id);
CREATE INDEX idx_api_keys_key ON api_keys(key);
```

### 3.4 new-api 导入接口

**接口定义**:

```
POST /api/token/import
Authorization: Bearer {admin_access_token}
Content-Type: application/json

{
    "key": "sk-a1B2c3D4...",      // 外部生成的密钥(不含sk-前缀)
    "external_user_id": "uuid",   // Supabase用户UUID
    "name": "default",            // 密钥名称
    "unlimited_quota": true       // 是否无限额度
}

Response:
{
    "success": true,
    "data": {
        "token_id": 123,          // new-api内部token_id
        "key": "a1B2c3D4..."      // 密钥(不含前缀)
    }
}
```

---

## 四、消费明细展示方案

### 4.1 方案选型

**选择方案A：基于密钥的消费数据API**

| 优势 | 说明 |
|------|------|
| 改动量小 | 仅需在new-api新增API，不涉及数据同步 |
| 实时性好 | 直接查询源数据，无延迟 |
| 数据完整 | logs表有token_id索引，可完整关联所有消费记录 |

### 4.2 数据完整性验证

通过代码分析确认：

```go
// model/log.go:35
TokenId int `json:"token_id" gorm:"default:0;index"`

// 每次消费都会记录token_id
// model/log.go:179
TokenId: params.TokenId,
```

**结论**：logs表通过token_id字段可以完整追踪每个密钥的所有消费记录。

### 4.3 新增API接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/usage/token/detail` | GET | 消费详情（含模型/日期分组） |
| `/api/usage/token/summary` | GET | 消费汇总统计 |
| `/api/usage/token/chart` | GET | 图表数据（支持hour/day/week粒度） |
| `/api/usage/token/logs` | GET | 消费日志列表（分页） |

### 4.4 返回数据结构

```json
// GET /api/usage/token/detail
{
    "success": true,
    "data": {
        "summary": {
            "total_quota": 50000,
            "total_requests": 120,
            "total_tokens": 45000,
            "avg_latency_ms": 1500
        },
        "by_model": [
            {
                "model_name": "gpt-4",
                "quota": 30000,
                "requests": 80,
                "tokens": 28000,
                "percentage": 60.0
            },
            {
                "model_name": "claude-3-opus",
                "quota": 20000,
                "requests": 40,
                "tokens": 17000,
                "percentage": 40.0
            }
        ],
        "by_day": [
            {"date": "2025-01-01", "quota": 15000, "requests": 35},
            {"date": "2025-01-02", "quota": 20000, "requests": 45},
            {"date": "2025-01-03", "quota": 15000, "requests": 40}
        ],
        "recent_logs": [
            {
                "id": 1001,
                "model_name": "gpt-4",
                "quota": 500,
                "prompt_tokens": 150,
                "completion_tokens": 200,
                "latency_ms": 1200,
                "created_at": 1704067200
            }
        ]
    }
}
```

### 4.5 门户图表展示

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        消费明细看板                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │ 总消耗      │ │ 请求次数     │ │ Token用量   │ │ 当前余额    │       │
│  │ ¥128.50    │ │ 1,234次     │ │ 450K       │ │ ¥371.50    │       │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │
│                                                                          │
│  ┌────────────────────────────────────┬───────────────────────────────┐ │
│  │        消费趋势图 (折线图)          │     模型消费分布 (饼图)        │ │
│  └────────────────────────────────────┴───────────────────────────────┘ │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐│
│  │                        最近消费记录                                   ││
│  ├──────────┬──────────┬────────┬────────┬────────────────────────────┤│
│  │ 时间     │ 模型     │ 消耗   │ Tokens │ 内容摘要                   ││
│  └──────────┴──────────┴────────┴────────┴────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 五、计费系统整合（规划中）

### 5.1 设计思路

通过Webhook将消费事件实时同步到Supabase，实现余额的实时更新。

```
new-api消费 → Webhook回调 → Supabase更新余额
```

### 5.2 用户余额计算

```
当前余额 = 充值累计 - 消费累计
         (Supabase)   (Webhook同步)
```

---

## 六、iframe通信优化（规划中）

### 6.1 设计思路

使用短期JWT令牌 + postMessage安全通信，替代URL参数传递。

```
门户平台 → 生成5分钟有效JWT → postMessage → iframe模块验证
```

---

## 七、实施优先级

| 优先级 | 模块 | 预计工期 | 依赖 |
|--------|------|----------|------|
| **P0** | Supabase密钥池 + Webhook同步 | 3-5天 | 无 |
| **P0** | 消费明细API (方案A) | 2-3天 | 无 |
| **P1** | 消费Webhook回调 | 2-3天 | P0完成 |
| **P2** | iframe短期令牌 | 2-3天 | P0完成 |

---

## 八、风险与注意事项

1. **Webhook可靠性**：需考虑重试机制和幂等性
2. **密钥安全**：传输过程需HTTPS，存储需加密
3. **性能考虑**：消费明细查询需合理使用索引和缓存
4. **兼容性**：新旧密钥格式的过渡处理

---

## 附录

### A. 代码位置索引

| 功能 | 文件位置 |
|------|----------|
| Token模型 | `model/token.go` |
| Log模型 | `model/log.go` |
| 密钥生成 | `common/utils.go:190-193` |
| 路由配置 | `router/api-router.go` |
| 认证中间件 | `middleware/auth.go` |

### B. 相关API文档

- 现有Token查询: `GET /api/usage/token` (`controller/token.go:86-135`)
- 现有日志查询: `GET /api/log/token` (`controller/log.go:84-99`)
